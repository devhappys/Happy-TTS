---
title: IPå°ç¦æ—¶é•¿éªŒè¯ä¿®å¤ - é˜²æ­¢å¼‚å¸¸æ•°å€¼å¯¼è‡´çš„å°ç¦æ—¶é—´é”™è¯¯
date: 2025-08-27
slug: ip-ban-duration-validation-fix
tags: [ip-ban, validation, security, bug-fix, backend, feature, blog]
---

# IPå°ç¦æ—¶é•¿éªŒè¯ä¿®å¤ - é˜²æ­¢å¼‚å¸¸æ•°å€¼å¯¼è‡´çš„å°ç¦æ—¶é—´é”™è¯¯

## é—®é¢˜æè¿°

åœ¨IPå°ç¦åŠŸèƒ½ä¸­å‘ç°äº†ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼šå½“ä¼ å…¥å¼‚å¸¸çš„ `durationMinutes` å€¼æ—¶ï¼Œç³»ç»Ÿæ²¡æœ‰è¿›è¡Œå……åˆ†çš„éªŒè¯ï¼Œå¯¼è‡´å°ç¦æ—¶é—´è®¡ç®—é”™è¯¯ã€‚

### é—®é¢˜ç¤ºä¾‹

```json
{
  "ipAddress": "127.0.0.1",
  "reason": "è¿è§„è¡Œä¸º - æ¶æ„è¯·æ±‚",
  "durationMinutes": 1.1111111111111112e39,
  "fingerprint": "optional_fingerprint",
  "userAgent": "optional_user_agent"
}
```

è¿™ä¸ªå¼‚å¸¸å¤§çš„æ•°å€¼ä¼šå¯¼è‡´ï¼š

- å°ç¦æ—¶é—´è®¡ç®—é”™è¯¯
- å¯èƒ½çš„æ•´æ•°æº¢å‡º
- æ•°æ®åº“å­˜å‚¨å¼‚å¸¸
- ç³»ç»Ÿæ€§èƒ½é—®é¢˜

## ä¿®å¤æ–¹æ¡ˆ

### 1. è¾“å…¥éªŒè¯å¢å¼º

```typescript
// éªŒè¯å’Œè®¾ç½®å°ç¦æ—¶é•¿
let banDuration = 60; // é»˜è®¤60åˆ†é’Ÿ

if (durationMinutes !== undefined && durationMinutes !== null) {
  // ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
  const duration = Number(durationMinutes);

  // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
  if (isNaN(duration) || !isFinite(duration)) {
    return res.status(400).json({
      success: false,
      error: "å°ç¦æ—¶é•¿å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—",
    });
  }

  // è®¾ç½®åˆç†çš„èŒƒå›´ï¼š1åˆ†é’Ÿåˆ°24å°æ—¶ï¼ˆ1440åˆ†é’Ÿï¼‰
  banDuration = Math.min(
    Math.max(duration, 1), // æœ€å°‘1åˆ†é’Ÿ
    24 * 60 // æœ€å¤š24å°æ—¶
  );
}
```

### 2. æœåŠ¡å±‚éªŒè¯

åœ¨ `TurnstileService.manualBanIp` æ–¹æ³•ä¸­æ·»åŠ ç›¸åŒçš„éªŒè¯é€»è¾‘ï¼š

```typescript
// éªŒè¯å°ç¦æ—¶é•¿
let validDuration = 60; // é»˜è®¤60åˆ†é’Ÿ

if (durationMinutes !== undefined && durationMinutes !== null) {
  // ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
  const duration = Number(durationMinutes);

  // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
  if (isNaN(duration) || !isFinite(duration)) {
    return {
      success: false,
      error: "å°ç¦æ—¶é•¿å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—",
    };
  }

  // è®¾ç½®åˆç†çš„èŒƒå›´ï¼š1åˆ†é’Ÿåˆ°24å°æ—¶ï¼ˆ1440åˆ†é’Ÿï¼‰
  validDuration = Math.min(Math.max(duration, 1), 24 * 60);
}
```

## éªŒè¯è§„åˆ™

### 1. æ•°æ®ç±»å‹éªŒè¯

- å¿…é¡»æ˜¯æ•°å­—ç±»å‹
- ä¸èƒ½æ˜¯ `NaN`
- ä¸èƒ½æ˜¯ `Infinity` æˆ– `-Infinity`

### 2. èŒƒå›´éªŒè¯

- **æœ€å°å€¼**: 1åˆ†é’Ÿ
- **æœ€å¤§å€¼**: 24å°æ—¶ï¼ˆ1440åˆ†é’Ÿï¼‰
- **é»˜è®¤å€¼**: 60åˆ†é’Ÿ

### 3. è¾¹ç•Œå¤„ç†

- å°äº1åˆ†é’Ÿçš„å€¼è‡ªåŠ¨è°ƒæ•´ä¸º1åˆ†é’Ÿ
- å¤§äº24å°æ—¶çš„å€¼è‡ªåŠ¨è°ƒæ•´ä¸º24å°æ—¶
- æœªæä¾›å€¼æ—¶ä½¿ç”¨é»˜è®¤60åˆ†é’Ÿ

## ä¿®å¤ä½ç½®

### 1. è·¯ç”±å±‚éªŒè¯

- `POST /api/turnstile/ban-ip` - å•ä¸ªIPå°ç¦
- `POST /api/turnstile/ban-ips` - æ‰¹é‡IPå°ç¦

### 2. æœåŠ¡å±‚éªŒè¯

- `TurnstileService.manualBanIp()` - æ‰‹åŠ¨å°ç¦IPæœåŠ¡

## æµ‹è¯•ç”¨ä¾‹

### 1. æ­£å¸¸æƒ…å†µæµ‹è¯•

```bash
# æµ‹è¯•æ­£å¸¸å°ç¦æ—¶é•¿
curl -X POST http://localhost:3000/api/turnstile/ban-ip \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "ipAddress": "127.0.0.1",
    "reason": "æµ‹è¯•å°ç¦",
    "durationMinutes": 30
  }'
```

**é¢„æœŸç»“æœ**: æˆåŠŸå°ç¦30åˆ†é’Ÿ

### 2. è¾¹ç•Œå€¼æµ‹è¯•

```bash
# æµ‹è¯•æœ€å°å€¼
curl -X POST http://localhost:3000/api/turnstile/ban-ip \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "ipAddress": "127.0.0.1",
    "reason": "æµ‹è¯•å°ç¦",
    "durationMinutes": 0
  }'
```

**é¢„æœŸç»“æœ**: è‡ªåŠ¨è°ƒæ•´ä¸º1åˆ†é’Ÿ

```bash
# æµ‹è¯•æœ€å¤§å€¼
curl -X POST http://localhost:3000/api/turnstile/ban-ip \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "ipAddress": "127.0.0.1",
    "reason": "æµ‹è¯•å°ç¦",
    "durationMinutes": 2000
  }'
```

**é¢„æœŸç»“æœ**: è‡ªåŠ¨è°ƒæ•´ä¸º1440åˆ†é’Ÿï¼ˆ24å°æ—¶ï¼‰

### 3. å¼‚å¸¸å€¼æµ‹è¯•

```bash
# æµ‹è¯•æ— æ•ˆæ•°å­—
curl -X POST http://localhost:3000/api/turnstile/ban-ip \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "ipAddress": "127.0.0.1",
    "reason": "æµ‹è¯•å°ç¦",
    "durationMinutes": "invalid"
  }'
```

**é¢„æœŸç»“æœ**: è¿”å›400é”™è¯¯ï¼Œæç¤º"å°ç¦æ—¶é•¿å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—"

```bash
# æµ‹è¯•æ— ç©·å¤§å€¼
curl -X POST http://localhost:3000/api/turnstile/ban-ip \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "ipAddress": "127.0.0.1",
    "reason": "æµ‹è¯•å°ç¦",
    "durationMinutes": 1e39
  }'
```

**é¢„æœŸç»“æœ**: è¿”å›400é”™è¯¯ï¼Œæç¤º"å°ç¦æ—¶é•¿å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—"

### 4. é»˜è®¤å€¼æµ‹è¯•

```bash
# æµ‹è¯•ä¸æä¾›æ—¶é•¿å‚æ•°
curl -X POST http://localhost:3000/api/turnstile/ban-ip \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "ipAddress": "127.0.0.1",
    "reason": "æµ‹è¯•å°ç¦"
  }'
```

**é¢„æœŸç»“æœ**: ä½¿ç”¨é»˜è®¤60åˆ†é’Ÿå°ç¦

## å®‰å…¨å½±å“

### 1. é˜²æ­¢æ”»å‡»

- é˜²æ­¢æ¶æ„ç”¨æˆ·é€šè¿‡å¼‚å¸¸æ•°å€¼æ”»å‡»ç³»ç»Ÿ
- é¿å…æ•°æ®åº“å­˜å‚¨å¼‚å¸¸æ•°æ®
- é˜²æ­¢ç³»ç»Ÿèµ„æºè€—å°½

### 2. æ•°æ®å®Œæ•´æ€§

- ç¡®ä¿å°ç¦æ—¶é—´åœ¨åˆç†èŒƒå›´å†…
- é˜²æ­¢æ—¶é—´è®¡ç®—é”™è¯¯
- ä¿è¯ç³»ç»Ÿç¨³å®šæ€§

### 3. ç”¨æˆ·ä½“éªŒ

- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
- è‡ªåŠ¨è°ƒæ•´ä¸åˆç†çš„æ—¶é—´èŒƒå›´
- ä¿æŒç³»ç»Ÿå“åº”æ€§

## é”™è¯¯å¤„ç†

### 1. é”™è¯¯å“åº”æ ¼å¼

```json
{
  "success": false,
  "error": "å°ç¦æ—¶é•¿å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ•°å­—"
}
```

### 2. æ—¥å¿—è®°å½•

```typescript
logger.warn("IPå°ç¦æ—¶é•¿éªŒè¯å¤±è´¥", {
  ipAddress,
  durationMinutes,
  error: "æ— æ•ˆçš„å°ç¦æ—¶é•¿",
});
```

### 3. ç›‘æ§å‘Šè­¦

- è®°å½•å¼‚å¸¸å°ç¦æ—¶é•¿è¯·æ±‚
- ç›‘æ§å°ç¦æ“ä½œé¢‘ç‡
- å‘Šè­¦å¼‚å¸¸å°ç¦æ¨¡å¼

## æœ€ä½³å®è·µ

### 1. è¾“å…¥éªŒè¯

- å§‹ç»ˆéªŒè¯ç”¨æˆ·è¾“å…¥
- ä½¿ç”¨ç±»å‹å®‰å…¨çš„éªŒè¯
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 2. è¾¹ç•Œå¤„ç†

- è®¾ç½®åˆç†çš„é»˜è®¤å€¼
- è‡ªåŠ¨è°ƒæ•´è¶…å‡ºèŒƒå›´çš„å€¼
- è®°å½•è¾¹ç•Œè°ƒæ•´æ“ä½œ

### 3. å®‰å…¨è€ƒè™‘

- é˜²æ­¢æ•°å€¼æº¢å‡º
- é™åˆ¶æœ€å¤§å°ç¦æ—¶é•¿
- ç›‘æ§å¼‚å¸¸æ“ä½œ

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†IPå°ç¦åŠŸèƒ½ä¸­çš„å®‰å…¨æ¼æ´ï¼š

### âœ… ä¿®å¤å†…å®¹

- **è¾“å…¥éªŒè¯å¢å¼º**: ä¸¥æ ¼éªŒè¯å°ç¦æ—¶é•¿å‚æ•°
- **ç±»å‹å®‰å…¨æ£€æŸ¥**: é˜²æ­¢NaNå’Œæ— ç©·å¤§å€¼
- **èŒƒå›´é™åˆ¶**: ç¡®ä¿å°ç¦æ—¶é•¿åœ¨åˆç†èŒƒå›´å†…
- **é”™è¯¯å¤„ç†**: æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

### ğŸ”§ æŠ€æœ¯æ”¹è¿›

- **å¤šå±‚éªŒè¯**: è·¯ç”±å±‚å’ŒæœåŠ¡å±‚åŒé‡éªŒè¯
- **è¾¹ç•Œå¤„ç†**: è‡ªåŠ¨è°ƒæ•´ä¸åˆç†çš„æ—¶é—´èŒƒå›´
- **æ—¥å¿—è®°å½•**: è®°å½•å¼‚å¸¸æ“ä½œä¾¿äºç›‘æ§
- **æµ‹è¯•è¦†ç›–**: å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯

### ğŸš€ å®‰å…¨æå‡

- **é˜²æ­¢æ”»å‡»**: é˜»æ­¢æ¶æ„æ•°å€¼æ”»å‡»
- **æ•°æ®å®Œæ•´æ€§**: ç¡®ä¿å°ç¦æ—¶é—´æ­£ç¡®
- **ç³»ç»Ÿç¨³å®š**: é¿å…å¼‚å¸¸å¯¼è‡´çš„ç³»ç»Ÿé—®é¢˜
- **ç”¨æˆ·ä½“éªŒ**: æä¾›å‹å¥½çš„é”™è¯¯æç¤º

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†IPå°ç¦åŠŸèƒ½çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œé˜²æ­¢äº†æ½œåœ¨çš„æ¶æ„æ”»å‡»å’Œç³»ç»Ÿå¼‚å¸¸ã€‚

---

**ç›¸å…³é“¾æ¥**

- [IPå°ç¦ç³»ç»Ÿå®ç°](./IP_BAN_SYSTEM.md)
- [IPå°ç¦ç®¡ç†API](./IP_BAN_MANAGEMENT_API.md)
- [å®‰å…¨æœ€ä½³å®è·µ](./SECURITY_BEST_PRACTICES.md)
