---
title: API 403çŠ¶æ€ç å¤„ç†ä¼˜åŒ–
date: 2025-08-27
slug: api-403-status-handling
tags: [api, 403, forbidden, security, optimization, blog]
---

# API 403çŠ¶æ€ç å¤„ç†ä¼˜åŒ–

## é—®é¢˜èƒŒæ™¯

åœ¨ HappyTTS é¡¹ç›®ä¸­ï¼Œå½“APIè¿”å›403çŠ¶æ€ç æ—¶ï¼Œç³»ç»Ÿä»ç„¶ä¼šç»§ç»­è¿›è¡Œåç»­è¯·æ±‚ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. **èµ„æºæµªè´¹**ï¼šä¸å¿…è¦çš„é‡å¤è¯·æ±‚æ¶ˆè€—æœåŠ¡å™¨èµ„æº
2. **æ€§èƒ½é—®é¢˜**ï¼šé¢‘ç¹çš„403è¯·æ±‚å½±å“ç³»ç»Ÿæ€§èƒ½
3. **ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·å¯èƒ½çœ‹åˆ°é‡å¤çš„é”™è¯¯ä¿¡æ¯
4. **å®‰å…¨é£é™©**ï¼šæŒç»­å°è¯•è®¿é—®æ— æƒé™çš„èµ„æºå¯èƒ½è¢«è®°å½•ä¸ºå¯ç–‘è¡Œä¸º

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ fetchWithAuthRetry å‡½æ•°

åœ¨ `fetchWithAuthRetry` å‡½æ•°ä¸­æ·»åŠ 403çŠ¶æ€ç çš„ç«‹å³åœæ­¢é€»è¾‘ï¼š

```typescript
// è¾…åŠ©ï¼šå¸¦401é‡è¯•çš„ fetchï¼ˆ401 æ—¶æœ€å¤šé‡è¯•ä¸¤æ¬¡ï¼Œæ€»å…±æœ€å¤šä¸‰æ¬¡ï¼Œ403 æ—¶ç«‹å³åœæ­¢ï¼‰
async function fetchWithAuthRetry(
  input: RequestInfo | URL,
  init?: RequestInit,
  max401Retries: number = 2
): Promise<Response> {
  let attempt = 0;
  let res: Response;
  do {
    res = await fetch(input, init);
    // å¦‚æœè¿”å›403ï¼Œç«‹å³åœæ­¢ï¼Œä¸å†é‡è¯•
    if (res.status === 403) {
      console.log("ğŸš« æ”¶åˆ°403çŠ¶æ€ç ï¼Œç”¨æˆ·æ²¡æœ‰æƒé™ï¼Œåœæ­¢è¯·æ±‚");
      return res;
    }
    if (res.status !== 401) return res;
    attempt++;
  } while (attempt <= max401Retries);
  return res;
}
```

### 2. è°ƒè¯•æ§åˆ¶å°é…ç½®åŒæ­¥ä¼˜åŒ–

åœ¨ `syncConfigFromBackend()` æ–¹æ³•ä¸­æ·»åŠ 403çŠ¶æ€ç æ£€æŸ¥ï¼š

```typescript
public async syncConfigFromBackend(): Promise<void> {
  try {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œéç®¡ç†å‘˜ç”¨æˆ·ä¸è¿›è¡Œé…ç½®åŒæ­¥
    if (!this.isUserAdmin()) {
      console.log('[è°ƒè¯•æ§åˆ¶å°] ç”¨æˆ·éç®¡ç†å‘˜ï¼Œè·³è¿‡é…ç½®åŒæ­¥');
      return;
    }

    // è·å–è®¤è¯token
    const token = localStorage.getItem('token');
    const headers: Record<string, string> = {
      'Content-Type': 'application/json'
    };

    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // å°è¯•è·å–åŠ å¯†é…ç½®ï¼ˆ401 æœ€å¤šé‡è¯•ä¸¤æ¬¡ï¼‰
    let response = await fetchWithAuthRetry('/api/debug-console/configs/encrypted', {
      headers
    }, 2);

    if (response.status === 401) {
      console.log('âš ï¸ åŒæ­¥é…ç½®éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè·³è¿‡è‡ªåŠ¨åŒæ­¥');
      return;
    }

    // å¦‚æœè¿”å›403ï¼Œè¯´æ˜ç”¨æˆ·æ²¡æœ‰æƒé™ï¼Œåœæ­¢åç»­è¯·æ±‚
    if (response.status === 403) {
      console.log('ğŸš« ç”¨æˆ·æ²¡æœ‰è°ƒè¯•æ§åˆ¶å°æƒé™ï¼Œåœæ­¢é…ç½®åŒæ­¥');
      return;
    }

    // ... å…¶ä½™åŒæ­¥é€»è¾‘
  } catch (error) {
    console.warn('ä»åç«¯åŒæ­¥è°ƒè¯•æ§åˆ¶å°é…ç½®å¤±è´¥:', error);
  }
}
```

### 3. æœªåŠ å¯†é…ç½®è¯·æ±‚ä¼˜åŒ–

åœ¨å›é€€åˆ°æœªåŠ å¯†é…ç½®æ—¶ä¹Ÿæ·»åŠ 403çŠ¶æ€ç æ£€æŸ¥ï¼š

```typescript
// å¦‚æœåŠ å¯†é…ç½®è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœªåŠ å¯†é…ç½®ï¼ˆ401 æœ€å¤šé‡è¯•ä¸¤æ¬¡ï¼‰
if (configs.length === 0) {
  response = await fetchWithAuthRetry(
    "/api/debug-console/configs",
    {
      headers,
    },
    2
  );

  // å¦‚æœè¿”å›403ï¼Œè¯´æ˜ç”¨æˆ·æ²¡æœ‰æƒé™ï¼Œåœæ­¢åç»­è¯·æ±‚
  if (response.status === 403) {
    console.log("ğŸš« ç”¨æˆ·æ²¡æœ‰è°ƒè¯•æ§åˆ¶å°æƒé™ï¼Œåœæ­¢é…ç½®åŒæ­¥");
    return;
  }

  if (response.ok) {
    data = await response.json();
    if (data.success && data.data && data.data.length > 0) {
      configs = data.data;
    }
  }
}
```

### 4. éªŒè¯ç éªŒè¯ä¼˜åŒ–

åœ¨ `verifyCode()` æ–¹æ³•ä¸­æ·»åŠ 403çŠ¶æ€ç æ£€æŸ¥ï¼š

```typescript
private async verifyCode(inputCode: string): Promise<void> {
  try {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œéç®¡ç†å‘˜ç”¨æˆ·ä¸è¿›è¡ŒéªŒè¯
    if (!this.isUserAdmin()) {
      console.log('[è°ƒè¯•æ§åˆ¶å°] ç”¨æˆ·éç®¡ç†å‘˜ï¼Œè·³è¿‡éªŒè¯ç éªŒè¯');
      return;
    }

    // è·å–å½“å‰æŒ‰é”®åºåˆ—
    const keySequence = this.keyBuffer || this.config.keySequence;

    // è°ƒç”¨åç«¯ API éªŒè¯
    const response = await fetch('/api/debug-console/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        keySequence,
        verificationCode: inputCode
      })
    });

    // å¦‚æœè¿”å›403ï¼Œè¯´æ˜ç”¨æˆ·æ²¡æœ‰æƒé™ï¼Œåœæ­¢éªŒè¯
    if (response.status === 403) {
      console.log('ğŸš« ç”¨æˆ·æ²¡æœ‰è°ƒè¯•æ§åˆ¶å°æƒé™ï¼ŒéªŒè¯å¤±è´¥');
      return;
    }

    const result = await response.json();

    if (result.success) {
      // ... éªŒè¯æˆåŠŸé€»è¾‘
    } else {
      // ... éªŒè¯å¤±è´¥é€»è¾‘
    }
  } catch (error) {
    console.error('âŒ éªŒè¯è¯·æ±‚å¤±è´¥:', error);
  }
}
```

### 5. å®šæ—¶å™¨ä¼˜åŒ–

åœ¨é…ç½®åŒæ­¥å®šæ—¶å™¨ä¸­æ·»åŠ é”™è¯¯å¤„ç†ï¼Œé‡åˆ°403æ—¶åœæ­¢å®šæ—¶å™¨ï¼š

```typescript
// å¯åŠ¨é…ç½®åŒæ­¥æœºåˆ¶
private startConfigSync(): void {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œéç®¡ç†å‘˜ç”¨æˆ·ä¸å¯åŠ¨é…ç½®åŒæ­¥
  if (!this.isUserAdmin()) {
    console.log('[è°ƒè¯•æ§åˆ¶å°] ç”¨æˆ·éç®¡ç†å‘˜ï¼Œè·³è¿‡é…ç½®åŒæ­¥æœºåˆ¶å¯åŠ¨');
    return;
  }

  // ç«‹å³åŒæ­¥ä¸€æ¬¡
  this.syncConfigFromBackend();

  // æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡é…ç½®
  const syncInterval = setInterval(() => {
    this.syncConfigFromBackend().catch(() => {
      // å¦‚æœåŒæ­¥å¤±è´¥ï¼Œåœæ­¢å®šæ—¶å™¨
      clearInterval(syncInterval);
    });
  }, 5 * 60 * 1000);

  // ... å…¶ä½™ç›‘å¬å™¨é€»è¾‘
}
```

## å®ç°ç»†èŠ‚

### 1. çŠ¶æ€ç å¤„ç†é€»è¾‘

- **401çŠ¶æ€ç **ï¼šè®¤è¯å¤±è´¥ï¼Œå¯ä»¥é‡è¯•ï¼ˆæœ€å¤šé‡è¯•2æ¬¡ï¼‰
- **403çŠ¶æ€ç **ï¼šæƒé™ä¸è¶³ï¼Œç«‹å³åœæ­¢ï¼Œä¸å†é‡è¯•
- **å…¶ä»–çŠ¶æ€ç **ï¼šæ­£å¸¸å¤„ç†

### 2. ç«‹å³åœæ­¢æœºåˆ¶

- **fetchWithAuthRetry**ï¼šåœ¨å¾ªç¯ä¸­æ£€æŸ¥403çŠ¶æ€ç ï¼Œç«‹å³è¿”å›
- **syncConfigFromBackend**ï¼šæ£€æŸ¥403çŠ¶æ€ç åç«‹å³è¿”å›ï¼Œä¸ç»§ç»­åç»­é€»è¾‘
- **verifyCode**ï¼šæ£€æŸ¥403çŠ¶æ€ç åç«‹å³è¿”å›ï¼Œä¸ç»§ç»­éªŒè¯æµç¨‹

### 3. å®šæ—¶å™¨ç®¡ç†

- **é”™è¯¯å¤„ç†**ï¼šåœ¨å®šæ—¶å™¨å›è°ƒä¸­æ·»åŠ é”™è¯¯å¤„ç†
- **è‡ªåŠ¨åœæ­¢**ï¼šé‡åˆ°é”™è¯¯æ—¶è‡ªåŠ¨æ¸…é™¤å®šæ—¶å™¨
- **èµ„æºæ¸…ç†**ï¼šé¿å…å†…å­˜æ³„æ¼

## ä¼˜åŒ–æ•ˆæœ

### 1. æ€§èƒ½æå‡

- **å‡å°‘è¯·æ±‚**ï¼š403çŠ¶æ€ç åä¸å†å‘é€é‡å¤è¯·æ±‚
- **é™ä½è´Ÿè½½**ï¼šå‡å°‘æœåŠ¡å™¨å¤„ç†å‹åŠ›
- **èŠ‚çœå¸¦å®½**ï¼šå‡å°‘ç½‘ç»œä¼ è¾“é‡

### 2. ç”¨æˆ·ä½“éªŒ

- **å¿«é€Ÿå“åº”**ï¼š403çŠ¶æ€ç åç«‹å³åœæ­¢ï¼Œç”¨æˆ·ä¸ä¼šç­‰å¾…
- **æ¸…æ™°åé¦ˆ**ï¼šæ˜ç¡®çš„æƒé™ä¸è¶³æç¤º
- **æ— é‡å¤é”™è¯¯**ï¼šé¿å…é‡å¤çš„é”™è¯¯ä¿¡æ¯

### 3. å®‰å…¨æ”¹è¿›

- **æƒé™æ§åˆ¶**ï¼šä¸¥æ ¼çš„æƒé™æ£€æŸ¥æœºåˆ¶
- **è¡Œä¸ºè®°å½•**ï¼šå‡å°‘å¯ç–‘çš„é‡å¤è¯·æ±‚
- **èµ„æºä¿æŠ¤**ï¼šé˜²æ­¢æ— æƒé™ç”¨æˆ·æ¶ˆè€—ç³»ç»Ÿèµ„æº

## ä½¿ç”¨åœºæ™¯

### 1. è°ƒè¯•æ§åˆ¶å°è®¿é—®

```typescript
// ç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ­£å¸¸è®¿é—®
const response = await fetch("/api/debug-console/configs");
// è¿”å›200ï¼Œæ­£å¸¸å¤„ç†

// éç®¡ç†å‘˜ç”¨æˆ·ï¼Œæƒé™ä¸è¶³
const response = await fetch("/api/debug-console/configs");
// è¿”å›403ï¼Œç«‹å³åœæ­¢ï¼Œä¸å†é‡è¯•
```

### 2. é…ç½®åŒæ­¥

```typescript
// ç”¨æˆ·æœ‰æƒé™
await debugConsoleManager.syncConfigFromBackend();
// æ­£å¸¸åŒæ­¥é…ç½®

// ç”¨æˆ·æ— æƒé™
await debugConsoleManager.syncConfigFromBackend();
// æ”¶åˆ°403ï¼Œç«‹å³åœæ­¢åŒæ­¥
```

### 3. éªŒè¯ç éªŒè¯

```typescript
// ç”¨æˆ·æœ‰æƒé™
await debugConsoleManager.verifyCode("123456");
// æ­£å¸¸éªŒè¯

// ç”¨æˆ·æ— æƒé™
await debugConsoleManager.verifyCode("123456");
// æ”¶åˆ°403ï¼Œç«‹å³åœæ­¢éªŒè¯
```

## æœ€ä½³å®è·µ

### 1. çŠ¶æ€ç å¤„ç†

- **æ˜ç¡®åŒºåˆ†**ï¼š401ï¼ˆè®¤è¯å¤±è´¥ï¼‰å’Œ403ï¼ˆæƒé™ä¸è¶³ï¼‰çš„å¤„ç†é€»è¾‘
- **ç«‹å³åœæ­¢**ï¼š403çŠ¶æ€ç åç«‹å³åœæ­¢ï¼Œä¸è¿›è¡Œé‡è¯•
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•403çŠ¶æ€ç ï¼Œä¾¿äºå®¡è®¡

### 2. é”™è¯¯å¤„ç†

- **ä¼˜é›…é™çº§**ï¼šæƒé™ä¸è¶³æ—¶ä¼˜é›…å¤„ç†ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
- **ç”¨æˆ·å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„æƒé™ä¸è¶³æç¤º
- **èµ„æºæ¸…ç†**ï¼šåŠæ—¶æ¸…ç†å®šæ—¶å™¨å’Œç›‘å¬å™¨

### 3. æ€§èƒ½ä¼˜åŒ–

- **å‡å°‘é‡è¯•**ï¼š403çŠ¶æ€ç ä¸è¿›è¡Œé‡è¯•
- **åœæ­¢å®šæ—¶å™¨**ï¼šé‡åˆ°é”™è¯¯æ—¶åœæ­¢ç›¸å…³å®šæ—¶å™¨
- **å†…å­˜ç®¡ç†**ï¼šé¿å…å†…å­˜æ³„æ¼

## ç›‘æ§å’Œæ—¥å¿—

### 1. è®¿é—®æ—¥å¿—

```typescript
// è®°å½•403çŠ¶æ€ç 
if (response.status === 403) {
  console.log("ğŸš« ç”¨æˆ·æ²¡æœ‰æƒé™ï¼Œåœæ­¢è¯·æ±‚");
  // å¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•
}
```

### 2. å®‰å…¨å®¡è®¡

```typescript
// è®°å½•æƒé™æ£€æŸ¥äº‹ä»¶
const logPermissionDenied = (endpoint: string, userId: string) => {
  console.log(`[æƒé™æ‹’ç»] ç”¨æˆ· ${userId} è®¿é—® ${endpoint} è¢«æ‹’ç»`);
};
```

## æ€»ç»“

é€šè¿‡æ·»åŠ 403çŠ¶æ€ç çš„ç«‹å³åœæ­¢å¤„ç†ï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

1. **æ€§èƒ½æå‡**ï¼šå‡å°‘ä¸å¿…è¦çš„é‡å¤è¯·æ±‚
2. **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿå“åº”æƒé™ä¸è¶³æƒ…å†µ
3. **å®‰å…¨æ”¹è¿›**ï¼šä¸¥æ ¼çš„æƒé™æ§åˆ¶å’Œèµ„æºä¿æŠ¤
4. **ç³»ç»Ÿç¨³å®š**ï¼šé¿å…æ— æƒé™ç”¨æˆ·çš„èµ„æºæ¶ˆè€—

è¿™ä¸ªä¼˜åŒ–æ—¢æå‡äº†ç³»ç»Ÿæ€§èƒ½ï¼Œåˆå¢å¼ºäº†å®‰å…¨æ€§ï¼Œæ˜¯ä¸€ä¸ªé‡è¦çš„æ”¹è¿›ã€‚
