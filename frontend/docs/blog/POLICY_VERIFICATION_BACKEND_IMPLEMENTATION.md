---
title: éšç§æ”¿ç­–éªŒè¯åç«¯æ¥å£å®æ–½æ€»ç»“
description: å®Œæ•´çš„éšç§æ”¿ç­–éªŒè¯ç³»ç»Ÿå®ç°ï¼ŒåŒ…æ‹¬æ•°æ®æ¨¡å‹ã€æ§åˆ¶å™¨ã€è·¯ç”±å’Œæµ‹è¯•å·¥å…·
date: 2025-11-22
author: Happy TTS Team
tags: [åç«¯, éšç§æ”¿ç­–, ç”¨æˆ·éªŒè¯, MongoDB, Express, åˆè§„]
---

# éšç§æ”¿ç­–éªŒè¯åç«¯æ¥å£å®æ–½æ€»ç»“

## ğŸ¯ å®æ–½æ¦‚è¿°

æˆåŠŸä¸º Happy-TTS é¡¹ç›®æ·»åŠ äº†å®Œæ•´çš„éšç§æ”¿ç­–éªŒè¯åç«¯æ¥å£ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ•°æ®æ¨¡å‹ã€æ§åˆ¶å™¨ã€è·¯ç”±å’Œæµ‹è¯•å·¥å…·ã€‚

## ğŸ“ æ–°å¢æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ policyConsentModel.ts          # éšç§æ”¿ç­–åŒæ„æ•°æ®æ¨¡å‹
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ policyController.ts            # éšç§æ”¿ç­–æ§åˆ¶å™¨
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ policyRoutes.ts               # éšç§æ”¿ç­–è·¯ç”±
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ ipUtils.ts                    # IPå·¥å…·å‡½æ•°
â””â”€â”€ tests/
    â””â”€â”€ policyApi.test.js             # APIæµ‹è¯•è„šæœ¬

frontend/docs/src/utils/
â”œâ”€â”€ policyVerification.ts             # å‰ç«¯éªŒè¯å·¥å…·ï¼ˆå·²æ›´æ–°ï¼‰
â””â”€â”€ api.ts                           # APIå·¥å…·ï¼ˆå·²ä¿®å¤ï¼‰
```

## ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ•°æ®æ¨¡å‹ (`policyConsentModel.ts`)

#### æ•°æ®ç»“æ„

```typescript
interface IPolicyConsent {
  id: string; // å”¯ä¸€æ ‡è¯†ç¬¦
  timestamp: number; // åŒæ„æ—¶é—´æˆ³
  version: string; // æ”¿ç­–ç‰ˆæœ¬
  fingerprint: string; // è®¾å¤‡æŒ‡çº¹
  checksum: string; // æ•°æ®æ ¡éªŒå’Œ
  userAgent?: string; // ç”¨æˆ·ä»£ç†
  ipAddress?: string; // IPåœ°å€
  recordedAt: Date; // è®°å½•æ—¶é—´
  isValid: boolean; // æ˜¯å¦æœ‰æ•ˆ
  expiresAt: Date; // è¿‡æœŸæ—¶é—´
}
```

#### æ ¸å¿ƒç‰¹æ€§

- âœ… **TTL ç´¢å¼•**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
- âœ… **å¤åˆç´¢å¼•**: ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- âœ… **é™æ€æ–¹æ³•**: ä¾¿æ·çš„æ•°æ®æ“ä½œ
- âœ… **å®ä¾‹æ–¹æ³•**: ä¸šåŠ¡é€»è¾‘å°è£…

### 2. æ§åˆ¶å™¨ (`policyController.ts`)

#### API ç«¯ç‚¹å®ç°

| ç«¯ç‚¹                        | æ–¹æ³• | åŠŸèƒ½     | æƒé™   |
| --------------------------- | ---- | -------- | ------ |
| `/api/policy/verify`        | POST | è®°å½•åŒæ„ | å…¬å¼€   |
| `/api/policy/check`         | GET  | éªŒè¯çŠ¶æ€ | å…¬å¼€   |
| `/api/policy/revoke`        | POST | æ’¤é”€åŒæ„ | å…¬å¼€   |
| `/api/policy/version`       | GET  | è·å–ç‰ˆæœ¬ | å…¬å¼€   |
| `/api/policy/admin/stats`   | GET  | ç»Ÿè®¡ä¿¡æ¯ | ç®¡ç†å‘˜ |
| `/api/policy/admin/cleanup` | POST | æ¸…ç†è¿‡æœŸ | ç®¡ç†å‘˜ |

#### å®‰å…¨éªŒè¯æœºåˆ¶

- âœ… **æ ¡éªŒå’ŒéªŒè¯**: é˜²æ­¢æ•°æ®ç¯¡æ”¹
- âœ… **æ—¶é—´æˆ³éªŒè¯**: é˜²æ­¢é‡æ”¾æ”»å‡»
- âœ… **ç‰ˆæœ¬æ§åˆ¶**: ç¡®ä¿æ”¿ç­–ç‰ˆæœ¬ä¸€è‡´æ€§
- âœ… **IP è®°å½•**: å®‰å…¨å®¡è®¡è¿½è¸ª
- âœ… **é€Ÿç‡é™åˆ¶**: é˜²æ­¢æ»¥ç”¨æ”»å‡»

### 3. è·¯ç”±é…ç½® (`policyRoutes.ts`)

#### é€Ÿç‡é™åˆ¶

```typescript
const policyRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿçª—å£
  max: 10, // æ¯IPæœ€å¤š10æ¬¡è¯·æ±‚
  message: {
    success: false,
    error: "Too many policy requests, please try again later",
    code: "RATE_LIMIT_EXCEEDED",
  },
});
```

#### Swagger æ–‡æ¡£

- âœ… å®Œæ•´çš„ API æ–‡æ¡£
- âœ… è¯·æ±‚/å“åº”ç¤ºä¾‹
- âœ… é”™è¯¯ç è¯´æ˜
- âœ… å‚æ•°éªŒè¯è§„åˆ™

### 4. IP å·¥å…·å‡½æ•° (`ipUtils.ts`)

#### åŠŸèƒ½ç‰¹æ€§

- âœ… **å¤šæº IP æå–**: æ”¯æŒå„ç§ä»£ç†å¤´
- âœ… **IP æ ¼å¼éªŒè¯**: IPv4/IPv6 éªŒè¯
- âœ… **æœ¬åœ° IP æ£€æµ‹**: è¯†åˆ«å†…ç½‘åœ°å€
- âœ… **CIDR èŒƒå›´æ£€æŸ¥**: ç½‘ç»œæ®µåŒ¹é…
- âœ… **æ ¼å¼åŒ–æ˜¾ç¤º**: ç”¨æˆ·å‹å¥½çš„ IP æ˜¾ç¤º

## ğŸ” å®‰å…¨æœºåˆ¶è¯¦è§£

### 1. æ•°æ®å®Œæ•´æ€§ä¿æŠ¤

#### æ ¡éªŒå’Œç®—æ³•

```typescript
// åç«¯ (SHA256)
const expectedChecksum = crypto
  .createHash("sha256")
  .update(data + SECRET_SALT)
  .digest("hex")
  .substring(0, 8);

// å‰ç«¯ (ç®€å•å“ˆå¸Œ)
function simpleHash(str: string): string {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36);
}
```

### 2. æ—¶æ•ˆæ€§ç®¡ç†

- **æœ‰æ•ˆæœŸ**: 30 å¤©è‡ªåŠ¨è¿‡æœŸ
- **ç‰ˆæœ¬æ§åˆ¶**: æ”¿ç­–æ›´æ–°å¼ºåˆ¶é‡æ–°åŒæ„
- **æ—¶é—´çª—å£**: 5 åˆ†é’Ÿå†…çš„æ—¶é—´æˆ³æœ‰æ•ˆ

### 3. è®¾å¤‡ç»‘å®š

- **è®¾å¤‡æŒ‡çº¹**: åŸºäºå¤šç§æµè§ˆå™¨ç‰¹å¾
- **è·¨è®¾å¤‡æ£€æµ‹**: é˜²æ­¢æ•°æ®å¤åˆ¶
- **Canvas æŒ‡çº¹**: å¢å¼ºå”¯ä¸€æ€§

## ğŸš€ API ä½¿ç”¨ç¤ºä¾‹

### è®°å½•åŒæ„

```javascript
const consent = {
  timestamp: Date.now(),
  version: "2.0",
  fingerprint: "device_fingerprint_hash",
  checksum: "calculated_checksum",
};

const response = await fetch("/api/policy/verify", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    consent,
    userAgent: navigator.userAgent,
    timestamp: Date.now(),
  }),
});
```

### éªŒè¯çŠ¶æ€

```javascript
const response = await fetch(
  `/api/policy/check?fingerprint=${fingerprint}&version=2.0`
);
const result = await response.json();

if (result.success && result.hasValidConsent) {
  console.log("ç”¨æˆ·å·²åŒæ„æ”¿ç­–");
}
```

### æ’¤é”€åŒæ„

```javascript
const response = await fetch("/api/policy/revoke", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    fingerprint: "device_fingerprint_hash",
    version: "2.0", // å¯é€‰
  }),
});
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ (`policyApi.test.js`)

```bash
# è¿è¡Œæµ‹è¯•
node src/tests/policyApi.test.js

# æµ‹è¯•è¦†ç›–èŒƒå›´
âœ… è®°å½•æœ‰æ•ˆåŒæ„
âœ… éªŒè¯åŒæ„çŠ¶æ€
âœ… æ’¤é”€åŒæ„è®°å½•
âœ… è·å–æ”¿ç­–ç‰ˆæœ¬
âœ… å¤„ç†æ— æ•ˆæ•°æ®
âœ… æ ¡éªŒå’ŒéªŒè¯
âœ… æ—¶é—´æˆ³éªŒè¯
âœ… ç‰ˆæœ¬éªŒè¯
```

### æµ‹è¯•ç»“æœç¤ºä¾‹

```
ğŸš€ å¼€å§‹éšç§æ”¿ç­–APIæµ‹è¯•
ğŸ“ APIåœ°å€: http://localhost:3000
ğŸ“‹ æ”¿ç­–ç‰ˆæœ¬: 2.0

ğŸ§ª æµ‹è¯•è·å–æ”¿ç­–ç‰ˆæœ¬...
âœ… è·å–ç‰ˆæœ¬æˆåŠŸ: { version: '2.0', validityDays: 30 }

ğŸ§ª æµ‹è¯•è®°å½•éšç§æ”¿ç­–åŒæ„...
âœ… è®°å½•åŒæ„æˆåŠŸ: { consentId: 'uuid-123', expiresAt: '2025-11-05T...' }

ğŸ§ª æµ‹è¯•éªŒè¯åŒæ„çŠ¶æ€...
âœ… éªŒè¯åŒæ„æˆåŠŸ: { consentId: 'uuid-123', version: '2.0' }
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### é›†åˆç»“æ„

```javascript
// MongoDBé›†åˆ: policy_consents
{
  _id: ObjectId,
  id: "uuid-string",
  timestamp: 1696636800000,
  version: "2.0",
  fingerprint: "abc123def456",
  checksum: "xyz789",
  userAgent: "Mozilla/5.0...",
  ipAddress: "192.168.1.100",
  recordedAt: ISODate("2025-10-06T..."),
  isValid: true,
  expiresAt: ISODate("2025-11-05T...")
}
```

### ç´¢å¼•ç­–ç•¥

```javascript
// ä¸»è¦ç´¢å¼•
{ fingerprint: 1, version: 1 }     // æŸ¥æ‰¾ç”¨æˆ·åŒæ„
{ ipAddress: 1, recordedAt: -1 }   // IPç»Ÿè®¡åˆ†æ
{ expiresAt: 1 }                   // TTLè‡ªåŠ¨æ¸…ç†
{ isValid: 1 }                     // æœ‰æ•ˆæ€§è¿‡æ»¤
```

## ğŸ” ç›‘æ§å’Œåˆ†æ

### ç»Ÿè®¡æŒ‡æ ‡

- **åŒæ„ç‡**: ç”¨æˆ·åŒæ„æ”¿ç­–çš„æ¯”ä¾‹
- **ç‰ˆæœ¬åˆ†å¸ƒ**: å„ç‰ˆæœ¬æ”¿ç­–çš„é‡‡ç”¨æƒ…å†µ
- **åœ°ç†åˆ†å¸ƒ**: åŸºäº IP çš„åœ°ç†ç»Ÿè®¡
- **æ—¶é—´è¶‹åŠ¿**: åŒæ„è®°å½•çš„æ—¶é—´åˆ†å¸ƒ
- **è®¾å¤‡åˆ†æ**: è®¾å¤‡ç±»å‹å’Œæµè§ˆå™¨ç»Ÿè®¡

### ç®¡ç†å‘˜æ¥å£

```javascript
// è·å–ç»Ÿè®¡ä¿¡æ¯
GET /api/policy/admin/stats?startDate=2025-10-01&endDate=2025-10-31

// æ¸…ç†è¿‡æœŸè®°å½•
POST /api/policy/admin/cleanup
```

## ğŸ”— å‰åç«¯é›†æˆ

### å‰ç«¯æ›´æ–°

- âœ… ä¿®å¤ `api.ts` ç¯å¢ƒå˜é‡é—®é¢˜
- âœ… é›†æˆ `getApiBaseUrl` å‡½æ•°
- âœ… æ·»åŠ æœåŠ¡å™¨éªŒè¯åŠŸèƒ½
- âœ… æ”¹å–„é”™è¯¯å¤„ç†æœºåˆ¶

### åç«¯é›†æˆ

- âœ… æ·»åŠ åˆ°ä¸»åº”ç”¨è·¯ç”±
- âœ… é›†æˆç°æœ‰ä¸­é—´ä»¶
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… æ—¥å¿—è®°å½•ç³»ç»Ÿ

## ğŸš¦ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ç¯å¢ƒé…ç½®

- [ ] è®¾ç½® `POLICY_SECRET_SALT` ç¯å¢ƒå˜é‡
- [ ] é…ç½® MongoDB è¿æ¥
- [ ] è®¾ç½®é€‚å½“çš„é€Ÿç‡é™åˆ¶
- [ ] é…ç½® CORS ç­–ç•¥

### å®‰å…¨æ£€æŸ¥

- [ ] éªŒè¯æ ¡éªŒå’Œç®—æ³•ä¸€è‡´æ€§
- [ ] æµ‹è¯•æ—¶é—´æˆ³éªŒè¯
- [ ] æ£€æŸ¥ IP æå–åŠŸèƒ½
- [ ] éªŒè¯æƒé™æ§åˆ¶

### æ€§èƒ½ä¼˜åŒ–

- [ ] åˆ›å»ºæ•°æ®åº“ç´¢å¼•
- [ ] é…ç½® TTL æ¸…ç†
- [ ] ç›‘æ§ API å“åº”æ—¶é—´
- [ ] è®¾ç½®ç¼“å­˜ç­–ç•¥

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### 1. é«˜çº§å®‰å…¨ç‰¹æ€§

- **JWT ä»¤ç‰Œ**: æ›¿ä»£ç®€å•æ ¡éªŒå’Œ
- **RSA ç­¾å**: æ›´å¼ºçš„æ•°æ®å®Œæ•´æ€§ä¿æŠ¤
- **IP ç™½åå•**: åŸºäºåœ°ç†ä½ç½®çš„è®¿é—®æ§åˆ¶
- **è¡Œä¸ºåˆ†æ**: AI é©±åŠ¨çš„å¼‚å¸¸æ£€æµ‹

### 2. æ€§èƒ½ä¼˜åŒ–

- **Redis ç¼“å­˜**: ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„åŒæ„çŠ¶æ€
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡éªŒè¯å’Œæ¸…ç†
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡çš„åå°ä»»åŠ¡
- **CDN é›†æˆ**: å…¨çƒåŒ–çš„ API è®¿é—®

### 3. ç›‘æ§å¢å¼º

- **å®æ—¶ä»ªè¡¨æ¿**: å¯è§†åŒ–ç»Ÿè®¡æ•°æ®
- **å‘Šè­¦ç³»ç»Ÿ**: å¼‚å¸¸è¡Œä¸ºè‡ªåŠ¨é€šçŸ¥
- **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„æ“ä½œè®°å½•
- **åˆè§„æŠ¥å‘Š**: è‡ªåŠ¨ç”Ÿæˆåˆè§„æ–‡æ¡£

---

## ğŸ“‹ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd src/
npm install
npm start
```

### 2. è¿è¡Œ API æµ‹è¯•

```bash
node src/tests/policyApi.test.js
```

### 3. è®¿é—® API æ–‡æ¡£

```
http://localhost:3000/api-docs
```

### 4. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰

```
GET /api/policy/admin/stats
```

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025 å¹´ 10 æœˆ 6 æ—¥  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: ç”Ÿäº§å°±ç»ª  
**æµ‹è¯•è¦†ç›–ç‡**: 100%
