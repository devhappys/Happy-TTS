name: Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    steps:
      - name: Check if PR is ready for auto-merge
        id: check-ready
        uses: actions/github-script@main
        with:
          script: |
            const { owner, repo } = context.repo;

            // å°è¯•ä»ä¸åŒçš„äº‹ä»¶ç±»å‹ä¸­è·å– PR ç¼–å·
            let pull_number = null;

            if (context.eventName === 'pull_request' || context.eventName === 'pull_request_review') {
              pull_number = context.payload.pull_request?.number || context.payload.number;
            } else if (context.eventName === 'workflow_dispatch') {
              // å¯¹äºæ‰‹åŠ¨è§¦å‘ï¼Œæ£€æŸ¥æ‰€æœ‰å¼€æ”¾çš„ PR
              console.log('Manual workflow dispatch - checking all open PRs');
              
              const { data: openPRs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                sort: 'updated',
                direction: 'desc'
              });
              
              console.log(`Found ${openPRs.length} open PRs`);
              
              // å¤„ç†æ‰€æœ‰å¼€æ”¾çš„ PR
              const results = [];
              for (const pr of openPRs) {
                const prNumber = pr.number;
                console.log(`\n=== æ£€æŸ¥ PR #${prNumber}: ${pr.title} ===`);
                
                // æ£€æŸ¥æ˜¯å¦ä¸º dependabot PR
                const isDependabot = pr.user.login === 'dependabot[bot]';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨åˆå¹¶æ ‡ç­¾
                const hasAutoMergeLabel = pr.labels.some(label => 
                  ['auto-merge', 'automerge', 'è‡ªåŠ¨åˆå¹¶'].includes(label.name.toLowerCase())
                );
                
                // æ£€æŸ¥ PR çŠ¶æ€
                const isApproved = pr.mergeable_state === 'clean';
                const hasConflicts = pr.mergeable === false;
                
                console.log(`Dependabot PR: ${isDependabot}`);
                console.log(`Has auto-merge label: ${hasAutoMergeLabel}`);
                console.log(`Mergeable state: ${pr.mergeable_state}`);
                console.log(`Has conflicts: ${hasConflicts}`);
                
                // å†³å®šæ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆå¹¶
                const shouldAutoMerge = (isDependabot || hasAutoMergeLabel) && !hasConflicts;
                
                if (shouldAutoMerge) {
                  try {
                    // ä½¿ç”¨ GraphQL API å¯ç”¨è‡ªåŠ¨åˆå¹¶
                    const mutation = `
                      mutation enableAutoMerge($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                        enablePullRequestAutoMerge(input: {
                          pullRequestId: $pullRequestId,
                          mergeMethod: $mergeMethod
                        }) {
                          pullRequest {
                            autoMergeRequest {
                              enabledAt
                            }
                          }
                        }
                      }
                    `;
                    
                    const variables = {
                      pullRequestId: pr.node_id,
                      mergeMethod: 'SQUASH'
                    };
                    
                    await github.graphql(mutation, variables);
                    
                    console.log(`âœ… å·²ä¸º PR #${prNumber} å¯ç”¨è‡ªåŠ¨åˆå¹¶`);
                    
                    // æ·»åŠ è¯„è®ºè¯´æ˜
                    await github.rest.issues.createComment({
                      owner,
                      repo,
                      issue_number: prNumber,
                      body: 'ğŸ¤– è‡ªåŠ¨åˆå¹¶å·²å¯ç”¨ï¼å½“æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œæ­¤ PR å°†è‡ªåŠ¨åˆå¹¶ã€‚'
                    });
                    
                    results.push({ pr: prNumber, status: 'enabled', title: pr.title });
                  } catch (error) {
                    console.log(`âŒ æ— æ³•ä¸º PR #${prNumber} å¯ç”¨è‡ªåŠ¨åˆå¹¶: ${error.message}`);
                    results.push({ pr: prNumber, status: 'failed', title: pr.title, error: error.message });
                  }
                } else {
                  console.log(`â­ï¸ è·³è¿‡ PR #${prNumber} (ä¸æ»¡è¶³è‡ªåŠ¨åˆå¹¶æ¡ä»¶)`);
                  results.push({ pr: prNumber, status: 'skipped', title: pr.title, reason: 'ä¸æ»¡è¶³è‡ªåŠ¨åˆå¹¶æ¡ä»¶' });
                }
              }
              
              // è¾“å‡ºæ€»ç»“
              console.log('\n=== æ‰‹åŠ¨è§¦å‘æ€»ç»“ ===');
              console.log(`æ€»å…±æ£€æŸ¥: ${openPRs.length} ä¸ª PR`);
              console.log(`å·²å¯ç”¨è‡ªåŠ¨åˆå¹¶: ${results.filter(r => r.status === 'enabled').length} ä¸ª`);
              console.log(`è·³è¿‡: ${results.filter(r => r.status === 'skipped').length} ä¸ª`);
              console.log(`å¤±è´¥: ${results.filter(r => r.status === 'failed').length} ä¸ª`);
              
              core.setOutput('should-merge', 'true');
              core.setOutput('pr-number', 'all');
              core.setOutput('results', JSON.stringify(results));
              
              return true;
            } else if (context.eventName === 'check_suite' || context.eventName === 'status') {
              // å¯¹äº check_suite å’Œ status äº‹ä»¶ï¼Œéœ€è¦ä» commits ä¸­æŸ¥æ‰¾å…³è”çš„ PR
              const commits = context.payload.check_suite?.head_sha ? 
                [context.payload.check_suite.head_sha] : 
                (context.payload.commits || []).map(c => c.sha);
              
              if (commits.length > 0) {
                // æŸ¥æ‰¾ä¸è¿™äº›æäº¤å…³è”çš„ PR
                const { data: prs } = await github.rest.pulls.list({
                  owner,
                  repo,
                  state: 'open',
                  head: `${owner}:${context.payload.repository?.default_branch || 'main'}`
                });
                
                // æŸ¥æ‰¾åŒ…å«è¿™äº›æäº¤çš„ PR
                for (const pr of prs) {
                  const { data: prCommits } = await github.rest.pulls.listCommits({
                    owner,
                    repo,
                    pull_number: pr.number
                  });
                  
                  const prCommitShas = prCommits.map(c => c.sha);
                  if (commits.some(sha => prCommitShas.includes(sha))) {
                    pull_number = pr.number;
                    break;
                  }
                }
              }
            }

            if (!pull_number) {
              console.log('No pull request number found for event:', context.eventName);
              return false;
            }

            // è·å– PR ä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });

            console.log(`æ£€æŸ¥ PR #${pull_number}: ${pr.title}`);

            // æ£€æŸ¥æ˜¯å¦ä¸º dependabot PR
            const isDependabot = pr.user.login === 'dependabot[bot]';

            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨åˆå¹¶æ ‡ç­¾
            const hasAutoMergeLabel = pr.labels.some(label => 
              ['auto-merge', 'automerge', 'è‡ªåŠ¨åˆå¹¶'].includes(label.name.toLowerCase())
            );

            // æ£€æŸ¥ PR çŠ¶æ€
            const isApproved = pr.mergeable_state === 'clean';
            const hasConflicts = pr.mergeable === false;

            console.log(`Dependabot PR: ${isDependabot}`);
            console.log(`Has auto-merge label: ${hasAutoMergeLabel}`);
            console.log(`Mergeable state: ${pr.mergeable_state}`);
            console.log(`Has conflicts: ${hasConflicts}`);

            // å†³å®šæ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆå¹¶
            const shouldAutoMerge = (isDependabot || hasAutoMergeLabel) && !hasConflicts;

            core.setOutput('should-merge', shouldAutoMerge);
            core.setOutput('pr-number', pull_number);

            return shouldAutoMerge;

      - name: Enable auto-merge for eligible PRs
        if: ${{ steps.check-ready.outputs.should-merge == 'true' && steps.check-ready.outputs.pr-number != 'all' }}
        uses: actions/github-script@main
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = ${{ steps.check-ready.outputs.pr-number }};

            try {
              // è·å– PR çš„ node_id
              const { data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });

              // ä½¿ç”¨ GraphQL API å¯ç”¨è‡ªåŠ¨åˆå¹¶
              const mutation = `
                mutation enableAutoMerge($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `;
              
              const variables = {
                pullRequestId: prData.node_id,
                mergeMethod: 'SQUASH'
              };
              
              await github.graphql(mutation, variables);

              console.log(`âœ… å·²ä¸º PR #${pull_number} å¯ç”¨è‡ªåŠ¨åˆå¹¶`);

              // æ·»åŠ è¯„è®ºè¯´æ˜
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: 'ğŸ¤– è‡ªåŠ¨åˆå¹¶å·²å¯ç”¨ï¼å½“æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œæ­¤ PR å°†è‡ªåŠ¨åˆå¹¶ã€‚'
              });

            } catch (error) {
              console.log(`âŒ æ— æ³•ä¸º PR #${pull_number} å¯ç”¨è‡ªåŠ¨åˆå¹¶: ${error.message}`);
            }

      - name: Summary for manual dispatch
        if: steps.check-ready.outputs.pr-number == 'all'
        run: |
          echo "æ‰‹åŠ¨è§¦å‘å®Œæˆï¼"
          echo "ç»“æœå·²è®°å½•åœ¨æ—¥å¿—ä¸­ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†è¾“å‡º"

  # ä¸“é—¨å¤„ç† Dependabot PRs çš„ä½œä¸š
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@main
        with:
          github-token: "${{ secrets.USER_PAT }}"

      - name: Auto-approve and enable auto-merge for Dependabot PRs
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: actions/github-script@main
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            try {
              // æ‰¹å‡† PR
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number,
                event: 'APPROVE',
                body: 'ğŸ¤– Dependabot è¡¥ä¸/æ¬¡è¦ç‰ˆæœ¬æ›´æ–°è‡ªåŠ¨æ‰¹å‡†'
              });
              
              // è·å– PR çš„ node_id ä»¥å¯ç”¨è‡ªåŠ¨åˆå¹¶
              const { data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });
              
              // ä½¿ç”¨ GraphQL API å¯ç”¨è‡ªåŠ¨åˆå¹¶
              const mutation = `
                mutation enableAutoMerge($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `;
              
              const variables = {
                pullRequestId: prData.node_id,
                mergeMethod: 'SQUASH'
              };
              
              await github.graphql(mutation, variables);
              
              console.log(`âœ… å·²ä¸º Dependabot PR #${pull_number} å¯ç”¨è‡ªåŠ¨åˆå¹¶`);
              
            } catch (error) {
              console.log(`âŒ å¤„ç† Dependabot PR #${pull_number} å¤±è´¥: ${error.message}`);
            }

      - name: Comment on major version updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "ğŸš¨ è¿™æ˜¯ä¸€ä¸ªä¸»ç‰ˆæœ¬æ›´æ–°ï¼Œéœ€è¦æ‰‹åŠ¨å®¡æŸ¥å’Œåˆå¹¶ã€‚"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
