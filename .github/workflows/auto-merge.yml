name: Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Check if PR is ready for auto-merge
        id: check-ready
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request?.number || context.payload.number;

            if (!pull_number) {
              console.log('No pull request number found');
              return false;
            }

            // è·å– PR ä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });

            console.log(`æ£€æŸ¥ PR #${pull_number}: ${pr.title}`);

            // æ£€æŸ¥æ˜¯å¦ä¸º dependabot PR
            const isDependabot = pr.user.login === 'dependabot[bot]';

            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨åˆå¹¶æ ‡ç­¾
            const hasAutoMergeLabel = pr.labels.some(label => 
              ['auto-merge', 'automerge', 'è‡ªåŠ¨åˆå¹¶'].includes(label.name.toLowerCase())
            );

            // æ£€æŸ¥ PR çŠ¶æ€
            const isApproved = pr.mergeable_state === 'clean';
            const hasConflicts = pr.mergeable === false;

            console.log(`Dependabot PR: ${isDependabot}`);
            console.log(`Has auto-merge label: ${hasAutoMergeLabel}`);
            console.log(`Mergeable state: ${pr.mergeable_state}`);
            console.log(`Has conflicts: ${hasConflicts}`);

            // å†³å®šæ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆå¹¶
            const shouldAutoMerge = (isDependabot || hasAutoMergeLabel) && !hasConflicts;

            core.setOutput('should-merge', shouldAutoMerge);
            core.setOutput('pr-number', pull_number);

            return shouldAutoMerge;

      - name: Enable auto-merge for eligible PRs
        if: steps.check-ready.outputs.should-merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = ${{ steps.check-ready.outputs.pr-number }};

            try {
              // å¯ç”¨è‡ªåŠ¨åˆå¹¶
              await github.rest.pulls.enableAutoMerge({
                owner,
                repo,
                pull_number,
                merge_method: 'squash' // å¯ä»¥æ”¹ä¸º 'merge' æˆ– 'rebase'
              });

              console.log(`âœ… å·²ä¸º PR #${pull_number} å¯ç”¨è‡ªåŠ¨åˆå¹¶`);

              // æ·»åŠ è¯„è®ºè¯´æ˜
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: 'ğŸ¤– è‡ªåŠ¨åˆå¹¶å·²å¯ç”¨ï¼å½“æ‰€æœ‰æ£€æŸ¥é€šè¿‡åï¼Œæ­¤ PR å°†è‡ªåŠ¨åˆå¹¶ã€‚'
              });

            } catch (error) {
              console.log(`âŒ æ— æ³•ä¸º PR #${pull_number} å¯ç”¨è‡ªåŠ¨åˆå¹¶: ${error.message}`);
            }

  # ä¸“é—¨å¤„ç† Dependabot PRs çš„ä½œä¸š
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@main
        with:
          github-token: "${{ secrets.USER_PAT }}"

      - name: Auto-approve and enable auto-merge for Dependabot PRs
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Comment on major version updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "ğŸš¨ è¿™æ˜¯ä¸€ä¸ªä¸»ç‰ˆæœ¬æ›´æ–°ï¼Œéœ€è¦æ‰‹åŠ¨å®¡æŸ¥å’Œåˆå¹¶ã€‚"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
