name: Build Docker Image For pull_request

on:
  push:
  pull_request:
  workflow_dispatch:
  issues:
  issue_comment:
  release:
  create:
  delete:
  fork:
  watch:
  deployment:
  deployment_status:
  page_build:
  public:
  status:
  milestone:
  project:
  project_card:
  project_column:
  repository_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天触发一次
permissions:
  contents: read
  packages: read

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Use Node.js
        uses: actions/setup-node@main
        with:
          node-version: 22

      - name: Set Node.js memory limits
        run: |
          echo "NODE_OPTIONS=--max-old-space-size=5096" >> $GITHUB_ENV
          echo "NPM_CONFIG_CACHE=/tmp/.npm" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@master

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@master


      - name: Build with memory optimization
        uses: docker/build-push-action@master
        env:
          BUILDKIT_MEM_LIMIT: 13g
        with:
          context: .
          platforms: linux/amd64
          build-args: |
            NODE_OPTIONS=--max-old-space-size=13000
          no-cache: true